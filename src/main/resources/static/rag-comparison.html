<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>RAG Comparison - –î–µ–Ω—å 16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üîç RAG Comparison & Citations Tool</h1>
        <p class="text-gray-600">–î–µ–Ω—å 18: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —Å RAG, –±–µ–∑ RAG –∏ —Å –¶–ò–¢–ê–¢–ê–ú–ò</p>
        <div class="mt-4 flex items-center space-x-4">
            <div class="flex items-center" id="status-indicator">
                <div class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                <span class="text-sm text-gray-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</span>
            </div>
            <div class="text-sm text-gray-600" id="stats"></div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
        <label class="block text-gray-700 font-semibold mb-2">–í–∞—à –≤–æ–ø—Ä–æ—Å:</label>
        <div class="flex space-x-4">
            <input
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    id="question-input"
                    onkeypress="if(event.key === 'Enter') compareRAG()"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–∏–µ –ø–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç?"
                    type="text"
            />
            <button
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-8 py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg"
                    id="compare-btn"
                    onclick="compareRAG()"
            >
                üöÄ –°—Ä–∞–≤–Ω–∏—Ç—å
            </button>
        </div>

        <!-- Quick Questions -->
        <div class="mt-4">
            <p class="text-sm text-gray-600 mb-2">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</p>
            <div class="flex flex-wrap gap-2">
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–∞—Ç–æ–º–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö?')">
                    –ê–Ω–∞—Ç–æ–º–∏—è
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫–∏–µ –ø–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç?')">
                    –ü–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ—Ä–º–∏—Ç—å –∂–∏–≤–æ—Ç–Ω—ã—Ö?')">
                    –ö–æ—Ä–º–ª–µ–Ω–∏–µ
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —É –∫—Ä—É–ø–Ω–æ–≥–æ —Ä–æ–≥–∞—Ç–æ–≥–æ —Å–∫–æ—Ç–∞?')">
                    –ö–†–°
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="hidden bg-white rounded-lg shadow-xl p-8 mb-6 text-center" id="loading">
        <div class="loading"></div>
        <p class="text-gray-600 mt-4">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-3 –º–∏–Ω—É—Ç—ã)</p>
        <p class="text-sm text-gray-500 mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–≤–∞ –æ—Ç–≤–µ—Ç–∞: —Å RAG –∏ –±–µ–∑ RAG</p>
    </div>

    <!-- Results -->
    <div class="hidden" id="results">
        <!-- Analysis Summary -->
        <div class="bg-white rounded-lg shadow-xl p-6 mb-6 fade-in" id="analysis-summary"></div>

        <!-- Comparison -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- With RAG -->
            <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-green-600">‚úÖ –° RAG</h2>
                    <span class="text-sm text-gray-500" id="rag-length"></span>
                </div>

                <!-- Quality Score Badge -->
                <div class="mb-4" id="quality-badge"></div>

                <!-- Suggestion Box -->
                <div class="mb-4 hidden" id="suggestion-box"></div>

                <div class="prose max-w-none text-gray-700 mb-4" id="rag-answer"></div>

                <div class="border-t pt-4 mt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</h3>
                    <div class="text-sm text-gray-600" id="rag-sources"></div>
                </div>

                <div class="mt-3 text-sm text-gray-500">
                    <span id="rag-chunks"></span> ‚Ä¢ <span id="rag-context"></span>
                </div>

                <!-- Alternative Chunks Button -->
                <div class="mt-4" id="alternatives-section">
                    <button
                            class="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold px-4 py-2 rounded-lg transition"
                            onclick="loadAlternativeChunks()"
                    >
                        üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ
                    </button>
                </div>
            </div>

            <!-- With RAG and Citations -->
            <div class="bg-white rounded-lg shadow-xl p-6 fade-in border-2 border-purple-400">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-purple-600">üéØ –° –¶–ò–¢–ê–¢–ê–ú–ò</h2>
                    <span class="text-xs bg-purple-100 text-purple-700 px-2 py-1 rounded">–î–µ–Ω—å 18</span>
                </div>

                <div class="mb-3 bg-purple-50 border border-purple-200 px-3 py-2 rounded-lg text-xs text-purple-700">
                    ‚úì –í—Å–µ —É—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —Ü–∏—Ç–∏—Ä—É—é—Ç—Å—è
                </div>

                <div class="prose max-w-none text-gray-700 mb-4 text-sm" id="rag-citations-answer"></div>

                <div class="border-t pt-4 mt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üìå –¶–∏—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏:</h3>
                    <div class="text-sm text-gray-600" id="rag-citations-sources"></div>
                </div>

                <div class="mt-3 text-sm text-gray-500">
                    <span id="rag-citations-count">0 —Ü–∏—Ç–∞—Ç</span> ‚Ä¢ <span id="rag-citations-chunks">0 –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</span>
                </div>
            </div>

            <!-- Without RAG -->
            <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-orange-600">‚ùå –ë–µ–∑ RAG</h2>
                    <span class="text-sm text-gray-500" id="no-rag-length"></span>
                </div>

                <div class="mb-3 bg-orange-50 border border-orange-200 px-3 py-2 rounded-lg text-xs text-orange-700">
                    ‚ö†Ô∏è –†–∏—Å–∫ –≥–∞–ª–ª—é—Ü–∏–Ω–∞—Ü–∏–π
                </div>

                <div class="prose max-w-none text-gray-700 mb-4 text-sm" id="no-rag-answer"></div>

                <div class="border-t pt-4 mt-4">
                    <p class="text-sm text-gray-500 italic">
                        –û—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö –º–æ–¥–µ–ª–∏, –±–µ–∑ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
                    </p>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üî¨ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
            <div class="space-y-4" id="detailed-analysis"></div>
        </div>
    </div>
</div>

<script>
    // Check system status on load
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/rag/status');
            const data = await response.json();

            const indicator = document.getElementById('status-indicator');
            if (data.ready && data.ollamaEmbedding && data.ollamaLLM) {
                indicator.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                        <span class="text-sm text-green-600 font-semibold">‚úì –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</span>
                    `;
            } else {
                indicator.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span class="text-sm text-red-600">‚úó –°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞</span>
                    `;
            }

            document.getElementById('stats').textContent =
                `üìä ${data.totalChunks} —á–∞–Ω–∫–æ–≤ ‚Ä¢ ${data.sources} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤`;
        } catch (error) {
            console.error('Error checking status:', error);
        }
    });

    function setQuestion(question) {
        document.getElementById('question-input').value = question;
    }

    async function compareRAG() {
        const question = document.getElementById('question-input').value.trim();

        if (!question) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
            return;
        }

        // Show loading, hide results
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
        document.getElementById('compare-btn').disabled = true;
        document.getElementById('compare-btn').textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

        try {
            // Fetch compare results (RAG vs no-RAG)
            const compareResponse = await fetch('/rag/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    topK: 3
                })
            });

            if (!compareResponse.ok) {
                throw new Error(`HTTP error! status: ${compareResponse.status}`);
            }

            const compareData = await compareResponse.json();

            // Fetch citations results
            const citationsResponse = await fetch('/rag/query-with-citations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    topK: 3
                })
            });

            let citationsData = null;
            if (citationsResponse.ok) {
                citationsData = await citationsResponse.json();
            }

            displayResults(compareData, citationsData);
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        } finally {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('compare-btn').disabled = false;
            document.getElementById('compare-btn').textContent = 'üöÄ –°—Ä–∞–≤–Ω–∏—Ç—å';
        }
    }

    // Store current question for alternative chunks
    let currentQuestion = '';

    function displayResults(data, citationsData) {
        currentQuestion = data.question || document.getElementById('question-input').value;

        // Analysis Summary
        const analysisSummary = document.getElementById('analysis-summary');
        const isHelpful = data.analysis?.ragHelpful ?? true;

        analysisSummary.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="text-6xl">${isHelpful ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold mb-2">
                            ${isHelpful ? 'RAG –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω!' : 'RAG —á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–º–æ–≥'}
                        </h2>
                        <p class="text-gray-700 text-lg">${data.analysis?.reason ?? '–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã'}</p>
                        <p class="text-gray-600 mt-2">${data.analysis?.specificityComparison ?? ''}</p>
                        ${citationsData ? '<p class="text-purple-600 mt-2">üéØ –°–∏—Å—Ç–µ–º–∞ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–î–µ–Ω—å 18): ' + (citationsData.retrievedChunks?.filter(c => c.isCited).length || 0) + ' –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ü–∏—Ç–∏—Ä–æ–≤–∞–Ω–æ</p>' : ''}
                    </div>
                </div>
            `;

        // Display quality score badge
        const qualityScore = data.withRAG?.qualityScore ?? 0;
        const qualityBadge = document.getElementById('quality-badge');

        if (qualityScore !== null && qualityScore !== undefined) {
            const qualityPercent = (qualityScore * 100).toFixed(0);
            let badgeColor = 'bg-red-100 text-red-700';
            let badgeIcon = '‚ùå';

            if (qualityScore >= 0.7) {
                badgeColor = 'bg-green-100 text-green-700';
                badgeIcon = '‚úÖ';
            } else if (qualityScore >= 0.5) {
                badgeColor = 'bg-yellow-100 text-yellow-700';
                badgeIcon = '‚ö†Ô∏è';
            }

            qualityBadge.innerHTML = `
                <div class="${badgeColor} px-4 py-2 rounded-lg text-sm font-semibold">
                    ${badgeIcon} –ö–∞—á–µ—Å—Ç–≤–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ${qualityPercent}%
                </div>
            `;
        }

        // Display suggestion if available
        const suggestion = data.withRAG?.suggestion;
        const suggestionBox = document.getElementById('suggestion-box');

        if (suggestion) {
            suggestionBox.classList.remove('hidden');
            suggestionBox.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 px-4 py-3 rounded-lg text-sm text-blue-800">
                    üí° ${suggestion}
                </div>
            `;
        }

        // Always show alternatives button after each query
        const alternativesSection = document.getElementById('alternatives-section');
        alternativesSection.classList.remove('hidden');

        // With RAG
        document.getElementById('rag-answer').textContent = data.withRAG?.answer || '–ù–µ—Ç –æ—Ç–≤–µ—Ç–∞';
        document.getElementById('rag-length').textContent = `${data.withRAG?.answerLength ?? 0} —Å–∏–º–≤–æ–ª–æ–≤`;
        document.getElementById('rag-chunks').textContent = `${data.withRAG?.retrievedChunksCount ?? 0} —á–∞–Ω–∫–æ–≤`;
        document.getElementById('rag-context').textContent = `${data.withRAG?.contextLength ?? 0} —Å–∏–º–≤–æ–ª–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞`;

        const sourcesDiv = document.getElementById('rag-sources');
        const topSources = data.withRAG?.topSources || [];

        if (topSources.length > 0) {
            sourcesDiv.innerHTML = topSources
                .map((source, idx) => `<div class="mb-1">üìÑ ${idx + 1}. ${source}</div>`)
                .join('');
        } else {
            sourcesDiv.innerHTML = '<div class="text-gray-400">–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ (–≤—Å–µ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã)</div>';
        }

        // Without RAG
        document.getElementById('no-rag-answer').textContent = data.withoutRAG.answer;
        document.getElementById('no-rag-length').textContent = `${data.withoutRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤`;

        // With RAG and Citations
        if (citationsData) {
            document.getElementById('rag-citations-answer').textContent = citationsData.answer || '–û—Ç–≤–µ—Ç –Ω–µ –ø–æ–ª—É—á–µ–Ω';

            const citedChunks = citationsData.retrievedChunks?.filter(c => c.isCited) || [];
            const citationCount = (citationsData.answer?.match(/\[Source \d+\]/g) || []).length;

            document.getElementById('rag-citations-count').textContent = `${citationCount} —Ü–∏—Ç–∞—Ç`;
            document.getElementById('rag-citations-chunks').textContent = `${citedChunks.length} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤`;

            const citationsSourcesDiv = document.getElementById('rag-citations-sources');
            if (citedChunks.length > 0) {
                citationsSourcesDiv.innerHTML = citedChunks
                    .map((chunk, idx) => {
                        const similarity = (chunk.similarity * 100).toFixed(1);
                        return `<div class="mb-2"><span class="font-semibold text-sm">${idx + 1}. ${chunk.sourceFile}</span> <span class="text-xs text-gray-500">–†–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç—å: ${similarity}%</span></div>`;
                    })
                    .join('');
            } else {
                citationsSourcesDiv.innerHTML = '<div class="text-gray-400 text-sm">–ò—Å—Ç–æ—á–Ω–∏–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';
            }
        } else {
            document.getElementById('rag-citations-answer').textContent = '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —Ü–∏—Ç–∞—Ç–∞–º–∏';
        }

        // Detailed Analysis
        const detailedAnalysis = document.getElementById('detailed-analysis');
        let factsHTML = '';

        if (data.analysis.factsFromContext && data.analysis.factsFromContext.length > 0) {
            factsHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">üìã –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            ${data.analysis.factsFromContext.slice(0, 5).map(fact =>
                `<li class="text-sm">${fact.substring(0, 150)}${fact.length > 150 ? '...' : ''}</li>`
            ).join('')}
                        </ul>
                    </div>
                `;
        }

        detailedAnalysis.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-700 mb-2">–° RAG</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚úì –î–ª–∏–Ω–∞: ${data.withRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤</li>
                            <li>‚úì –ß–∞–Ω–∫–æ–≤: ${data.withRAG.retrievedChunksCount}</li>
                            <li>‚úì –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${(data.withRAG.contextLength / 1024).toFixed(1)} KB</li>
                        </ul>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-orange-700 mb-2">–ë–µ–∑ RAG</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚úì –î–ª–∏–Ω–∞: ${data.withoutRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤</li>
                            <li>‚úì –¢–æ–ª—å–∫–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏</li>
                            <li>‚úì –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</li>
                        </ul>
                    </div>
                </div>
                ${factsHTML}
            `;

        // Show results
        document.getElementById('results').classList.remove('hidden');

        // Scroll to results
        document.getElementById('results').scrollIntoView({behavior: 'smooth', block: 'start'});
    }

    async function loadAlternativeChunks() {
        if (!currentQuestion) {
            alert('–ù–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –≤–æ–ø—Ä–æ—Å–∞');
            return;
        }

        const alternativesSection = document.getElementById('alternatives-section');
        const button = alternativesSection.querySelector('button');
        button.disabled = true;
        button.textContent = '‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const response = await fetch('/rag/query-alternatives', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: currentQuestion,
                    offset: 0,
                    limit: 3
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            displayAlternativeResults(data);
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤: ' + error.message);
        } finally {
            button.disabled = false;
            button.textContent = 'üîÑ –ü–æ–∫–∞–∑–∞—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã';
        }
    }

    function displayAlternativeResults(data) {
        const sourcesDiv = document.getElementById('rag-sources');

        if (!data.retrievedChunks || data.retrievedChunks.length === 0) {
            sourcesDiv.innerHTML = `
                <div class="bg-yellow-50 border border-yellow-200 px-4 py-3 rounded-lg text-sm text-yellow-800 mb-3">
                    ${data.suggestion || '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤'}
                </div>
            `;
            return;
        }

        // Update answer
        document.getElementById('rag-answer').textContent = data.answer || '–û—Ç–≤–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã—Ö —á–∞–Ω–∫–æ–≤';

        // Update sources with alternative chunks
        let sourcesHTML = `
            <div class="bg-blue-50 border border-blue-200 px-3 py-2 rounded-lg text-xs text-blue-700 mb-3">
                üîÑ –ü–æ–∫–∞–∑–∞–Ω—ã –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã (–æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–Ω–µ–µ)
            </div>
        `;

        sourcesHTML += data.retrievedChunks.map((chunk, idx) => {
            const similarity = (chunk.similarity * 100).toFixed(1);
            return `
                <div class="mb-3 p-3 bg-gray-50 rounded-lg">
                    <div class="flex items-center justify-between mb-2">
                        <span class="font-semibold text-sm">üìÑ ${idx + 1}. ${chunk.sourceFile}</span>
                        <span class="text-xs text-gray-500">Similarity: ${similarity}%</span>
                    </div>
                    ${chunk.headingContext ? `<div class="text-xs text-blue-600 mb-1">üìç ${chunk.headingContext}</div>` : ''}
                    <div class="text-sm text-gray-700">${chunk.text.substring(0, 200)}${chunk.text.length > 200 ? '...' : ''}</div>
                </div>
            `;
        }).join('');

        if (data.alternativeChunksAvailable) {
            sourcesHTML += `
                <div class="text-sm text-gray-600 mt-3">
                    üí° ${data.suggestion}
                </div>
            `;
        }

        sourcesDiv.innerHTML = sourcesHTML;
    }
</script>
</body>
</html>

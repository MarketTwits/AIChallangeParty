<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>RAG Comparison - –î–µ–Ω—å 16</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loading {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        .fade-in {
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen p-4">
<div class="max-w-7xl mx-auto">
    <!-- Header -->
    <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
        <h1 class="text-4xl font-bold text-gray-800 mb-2">üîç RAG Comparison Tool</h1>
        <p class="text-gray-600">–î–µ–Ω—å 16: –°—Ä–∞–≤–Ω–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ —Å RAG –∏ –±–µ–∑ RAG</p>
        <div class="mt-4 flex items-center space-x-4">
            <div class="flex items-center" id="status-indicator">
                <div class="w-3 h-3 rounded-full bg-gray-400 mr-2"></div>
                <span class="text-sm text-gray-600">–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–∏—Å—Ç–µ–º—ã...</span>
            </div>
            <div class="text-sm text-gray-600" id="stats"></div>
        </div>
    </div>

    <!-- Input Form -->
    <div class="bg-white rounded-lg shadow-xl p-6 mb-6">
        <label class="block text-gray-700 font-semibold mb-2">–í–∞—à –≤–æ–ø—Ä–æ—Å:</label>
        <div class="flex space-x-4">
            <input
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    id="question-input"
                    onkeypress="if(event.key === 'Enter') compareRAG()"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ö–∞–∫–∏–µ –ø–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç?"
                    type="text"
            />
            <button
                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-8 py-3 rounded-lg transition duration-200 shadow-md hover:shadow-lg"
                    id="compare-btn"
                    onclick="compareRAG()"
            >
                üöÄ –°—Ä–∞–≤–Ω–∏—Ç—å
            </button>
        </div>

        <!-- Quick Questions -->
        <div class="mt-4">
            <p class="text-sm text-gray-600 mb-2">–ë—ã—Å—Ç—Ä—ã–µ –≤–æ–ø—Ä–æ—Å—ã:</p>
            <div class="flex flex-wrap gap-2">
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ß—Ç–æ —Ç–∞–∫–æ–µ –∞–Ω–∞—Ç–æ–º–∏—è –∂–∏–≤–æ—Ç–Ω—ã—Ö?')">
                    –ê–Ω–∞—Ç–æ–º–∏—è
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫–∏–µ –ø–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π —Å—É—â–µ—Å—Ç–≤—É—é—Ç?')">
                    –ü–æ—Ä–æ–¥—ã —Å–≤–∏–Ω–µ–π
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∫–æ—Ä–º–∏—Ç—å –∂–∏–≤–æ—Ç–Ω—ã—Ö?')">
                    –ö–æ—Ä–º–ª–µ–Ω–∏–µ
                </button>
                <button class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded-full text-sm transition"
                        onclick="setQuestion('–ö–∞–∫–∏–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ —É –∫—Ä—É–ø–Ω–æ–≥–æ —Ä–æ–≥–∞—Ç–æ–≥–æ —Å–∫–æ—Ç–∞?')">
                    –ö–†–°
                </button>
            </div>
        </div>
    </div>

    <!-- Loading State -->
    <div class="hidden bg-white rounded-lg shadow-xl p-8 mb-6 text-center" id="loading">
        <div class="loading"></div>
        <p class="text-gray-600 mt-4">–û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞... (—ç—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å 2-3 –º–∏–Ω—É—Ç—ã)</p>
        <p class="text-sm text-gray-500 mt-2">–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–≤–∞ –æ—Ç–≤–µ—Ç–∞: —Å RAG –∏ –±–µ–∑ RAG</p>
    </div>

    <!-- Results -->
    <div class="hidden" id="results">
        <!-- Analysis Summary -->
        <div class="bg-white rounded-lg shadow-xl p-6 mb-6 fade-in" id="analysis-summary"></div>

        <!-- Comparison -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- With RAG -->
            <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-green-600">‚úÖ –° RAG</h2>
                    <span class="text-sm text-gray-500" id="rag-length"></span>
                </div>
                <div class="prose max-w-none text-gray-700 mb-4" id="rag-answer"></div>

                <div class="border-t pt-4 mt-4">
                    <h3 class="font-semibold text-gray-700 mb-2">üìö –ò—Å—Ç–æ—á–Ω–∏–∫–∏:</h3>
                    <div class="text-sm text-gray-600" id="rag-sources"></div>
                </div>

                <div class="mt-3 text-sm text-gray-500">
                    <span id="rag-chunks"></span> ‚Ä¢ <span id="rag-context"></span>
                </div>
            </div>

            <!-- Without RAG -->
            <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-2xl font-bold text-orange-600">‚ùå –ë–µ–∑ RAG</h2>
                    <span class="text-sm text-gray-500" id="no-rag-length"></span>
                </div>
                <div class="prose max-w-none text-gray-700 mb-4" id="no-rag-answer"></div>

                <div class="border-t pt-4 mt-4">
                    <p class="text-sm text-gray-500 italic">
                        –û—Ç–≤–µ—Ç –æ—Å–Ω–æ–≤–∞–Ω —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–±—â–∏—Ö –∑–Ω–∞–Ω–∏—è—Ö –º–æ–¥–µ–ª–∏, –±–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –±–∞–∑—ã –∑–Ω–∞–Ω–∏–π
                    </p>
                </div>
            </div>
        </div>

        <!-- Detailed Analysis -->
        <div class="bg-white rounded-lg shadow-xl p-6 fade-in">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">üî¨ –î–µ—Ç–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑</h2>
            <div class="space-y-4" id="detailed-analysis"></div>
        </div>
    </div>
</div>

<script>
    // Check system status on load
    window.addEventListener('DOMContentLoaded', async () => {
        try {
            const response = await fetch('/rag/status');
            const data = await response.json();

            const indicator = document.getElementById('status-indicator');
            if (data.ready && data.ollamaEmbedding && data.ollamaLLM) {
                indicator.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-green-500 mr-2 animate-pulse"></div>
                        <span class="text-sm text-green-600 font-semibold">‚úì –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞</span>
                    `;
            } else {
                indicator.innerHTML = `
                        <div class="w-3 h-3 rounded-full bg-red-500 mr-2"></div>
                        <span class="text-sm text-red-600">‚úó –°–∏—Å—Ç–µ–º–∞ –Ω–µ –≥–æ—Ç–æ–≤–∞</span>
                    `;
            }

            document.getElementById('stats').textContent =
                `üìä ${data.totalChunks} —á–∞–Ω–∫–æ–≤ ‚Ä¢ ${data.sources} –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤`;
        } catch (error) {
            console.error('Error checking status:', error);
        }
    });

    function setQuestion(question) {
        document.getElementById('question-input').value = question;
    }

    async function compareRAG() {
        const question = document.getElementById('question-input').value.trim();

        if (!question) {
            alert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –≤–æ–ø—Ä–æ—Å');
            return;
        }

        // Show loading, hide results
        document.getElementById('loading').classList.remove('hidden');
        document.getElementById('results').classList.add('hidden');
        document.getElementById('compare-btn').disabled = true;
        document.getElementById('compare-btn').textContent = '‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞...';

        try {
            const response = await fetch('/rag/compare', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    question: question,
                    topK: 3
                })
            });

            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();
            displayResults(data);
        } catch (error) {
            console.error('Error:', error);
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–ø—Ä–æ—Å–∞: ' + error.message);
        } finally {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('compare-btn').disabled = false;
            document.getElementById('compare-btn').textContent = 'üöÄ –°—Ä–∞–≤–Ω–∏—Ç—å';
        }
    }

    function displayResults(data) {
        // Analysis Summary
        const analysisSummary = document.getElementById('analysis-summary');
        const isHelpful = data.analysis.ragHelpful;

        analysisSummary.innerHTML = `
                <div class="flex items-start space-x-4">
                    <div class="text-6xl">${isHelpful ? '‚úÖ' : '‚ö†Ô∏è'}</div>
                    <div class="flex-1">
                        <h2 class="text-2xl font-bold mb-2">
                            ${isHelpful ? 'RAG –±—ã–ª –ø–æ–ª–µ–∑–µ–Ω!' : 'RAG —á–∞—Å—Ç–∏—á–Ω–æ –ø–æ–º–æ–≥'}
                        </h2>
                        <p class="text-gray-700 text-lg">${data.analysis.reason}</p>
                        <p class="text-gray-600 mt-2">${data.analysis.specificityComparison}</p>
                    </div>
                </div>
            `;

        // With RAG
        document.getElementById('rag-answer').textContent = data.withRAG.answer;
        document.getElementById('rag-length').textContent = `${data.withRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤`;
        document.getElementById('rag-chunks').textContent = `${data.withRAG.retrievedChunksCount} —á–∞–Ω–∫–æ–≤`;
        document.getElementById('rag-context').textContent = `${data.withRAG.contextLength} —Å–∏–º–≤–æ–ª–æ–≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞`;

        const sourcesDiv = document.getElementById('rag-sources');
        if (data.withRAG.topSources.length > 0) {
            sourcesDiv.innerHTML = data.withRAG.topSources
                .map((source, idx) => `<div class="mb-1">üìÑ ${idx + 1}. ${source}</div>`)
                .join('');
        } else {
            sourcesDiv.innerHTML = '<div class="text-gray-400">–ù–µ—Ç –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤</div>';
        }

        // Without RAG
        document.getElementById('no-rag-answer').textContent = data.withoutRAG.answer;
        document.getElementById('no-rag-length').textContent = `${data.withoutRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤`;

        // Detailed Analysis
        const detailedAnalysis = document.getElementById('detailed-analysis');
        let factsHTML = '';

        if (data.analysis.factsFromContext && data.analysis.factsFromContext.length > 0) {
            factsHTML = `
                    <div>
                        <h3 class="font-semibold text-gray-700 mb-2">üìã –ö–ª—é—á–µ–≤—ã–µ —Ñ–∞–∫—Ç—ã –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞:</h3>
                        <ul class="list-disc list-inside space-y-1 text-gray-600">
                            ${data.analysis.factsFromContext.slice(0, 5).map(fact =>
                `<li class="text-sm">${fact.substring(0, 150)}${fact.length > 150 ? '...' : ''}</li>`
            ).join('')}
                        </ul>
                    </div>
                `;
        }

        detailedAnalysis.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="bg-green-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-green-700 mb-2">–° RAG</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚úì –î–ª–∏–Ω–∞: ${data.withRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤</li>
                            <li>‚úì –ß–∞–Ω–∫–æ–≤: ${data.withRAG.retrievedChunksCount}</li>
                            <li>‚úì –ö–æ–Ω—Ç–µ–∫—Å—Ç: ${(data.withRAG.contextLength / 1024).toFixed(1)} KB</li>
                        </ul>
                    </div>
                    <div class="bg-orange-50 p-4 rounded-lg">
                        <h3 class="font-semibold text-orange-700 mb-2">–ë–µ–∑ RAG</h3>
                        <ul class="text-sm text-gray-700 space-y-1">
                            <li>‚úì –î–ª–∏–Ω–∞: ${data.withoutRAG.answerLength} —Å–∏–º–≤–æ–ª–æ–≤</li>
                            <li>‚úì –¢–æ–ª—å–∫–æ –æ–±—â–∏–µ –∑–Ω–∞–Ω–∏—è –º–æ–¥–µ–ª–∏</li>
                            <li>‚úì –ë–µ–∑ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤</li>
                        </ul>
                    </div>
                </div>
                ${factsHTML}
            `;

        // Show results
        document.getElementById('results').classList.remove('hidden');

        // Scroll to results
        document.getElementById('results').scrollIntoView({behavior: 'smooth', block: 'start'});
    }
</script>
</body>
</html>

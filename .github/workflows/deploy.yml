name: Deploy to VPS

on:
  workflow_dispatch:
  push:
    branches: [ main, master ]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build --platform linux/amd64 --no-cache -t ai-running-coach:latest .

      - name: Test Docker image
        run: |
          # Start container for testing
          docker run -d --name test-container -p 8081:8080 \
            -e ANTHROPIC_API_KEY=test_key \
            -e HUGGINGFACE_API_KEY=test_key \
            ai-running-coach:latest

          # Wait for container to start
          sleep 20

          # Test health endpoint
          if curl -f http://localhost:8081/health; then
            echo "âœ… Health check passed"
          else
            echo "âŒ Health check failed"
            docker logs test-container
            exit 1
          fi

          # Stop test container
          docker stop test-container
          docker rm test-container

      - name: Save Docker image
        run: |
          docker save ai-running-coach:latest | gzip > ai-running-coach.tar.gz

      - name: Deploy to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          source: "ai-running-coach.tar.gz,docker-compose.yml"
          target: "~/ai-coauch/"

      - name: Load and restart container on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USERNAME }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            set -e  # Exit on any error

            echo "ğŸš€ Starting deployment..."
            cd ~/ai-coauch

            echo "ğŸ›‘ Stopping current container..."
            docker compose down || true
            sleep 5

            echo "ğŸ—‘ï¸ Removing old image..."
            docker rmi ai-running-coach:latest 2>/dev/null || true

            echo "ğŸ“¦ Loading new image..."
            gunzip -c ai-running-coach.tar.gz | docker load

            echo "ğŸš€ Starting new container..."
            docker compose up -d

            echo "â³ Waiting for container to start..."
            sleep 15

            echo "ğŸ¥ Checking health..."
            sleep 10

            # Check if container is running
            if docker ps | grep -q ai-running-coach; then
              echo "âœ… Container is running"
            else
              echo "âŒ Container failed to start"
              docker compose logs ai-running-coach
              exit 1
            fi

            # Check health endpoint (if curl is available)
            if command -v curl &> /dev/null; then
              if curl -f -s http://localhost:8080/health > /dev/null; then
                echo "âœ… Health check passed"
              else
                echo "âš ï¸ Health check failed, but container is running"
                docker compose logs ai-running-coach --tail 20
              fi
            fi

            echo "ğŸ§¹ Cleaning up..."
            docker system prune -f

            echo "âœ… Deployment completed successfully!"
